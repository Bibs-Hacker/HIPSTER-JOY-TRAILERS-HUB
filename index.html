<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MERA-B Movie Hub — Search · Trailer · Play · (User) Download</title>
<style>
  :root{
    --bg:#ff3fff; --card:#0f1720; --accent:#8b5cf6; --muted:#094ffe;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
  body{margin:0;background:
    radial-gradient(800px 400px at 10% 10%, rgba(139,92,246,0.06), transparent 10%),
    radial-gradient(600px 300px at 90% 90%, rgba(14,165,233,0.04), transparent 10%),
    var(--bg);
    color:#e6eef8; -webkit-font-smoothing:antialiased}
  header{display:flex;gap:12px;align-items:center;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.03);backdrop-filter: blur(6px)}
  .logo{display:flex;align-items:center;gap:12px}
  .logo .dot{width:110px;height:45px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#0ffeff);display:flex;align-items:center;justify-content:center;font-weight:800;color:#021028;animation:bounce 3s;box-shadow:0 8px 30px rgba(139,92,246,0.12)}
  h1{margin:0;font-size:18px}
  .searchbar{margin-left:auto;display:flex;gap:8px;align-items:center}
  input[type="search"]{background:var(--glass);border:4px solid rgba(255,255,255,1.04);padding:10px 12px;border-radius:10px;color:inherit;min-width:240px}
  button{background:transparent;border:4px solid rgba(25,255,255,1.06);padding:9px 12px;border-radius:10px;color:inherit;cursor:pointer}
  main{padding:18px;display:grid;grid-template-columns:1fr 340px;gap:18px}
  .results{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:16px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;overflow:hidden;box-shadow:0 6px 26px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.02)}
  .poster{width:100%;height:225px;background:#071029;background-size:cover;background-position:center}
  .meta{padding:10px}
  .meta h3{margin:0;font-size:14px;line-height:1.2}
  .meta p{margin:6px 0 0;font-size:12px;color:var(--muted)}
  .sidebar{position:sticky;top:18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
  .notice{font-size:12px;color:var(--muted);padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:10px}
  .controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .load-more{display:block;margin:12px auto;padding:10px 16px;border-radius:10px}
  /* detail modal */
  .detail{position:fixed;inset:0;background:linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.9));display:none;align-items:center;justify-content:center;padding:24px;z-index:60}
  .detail.open{display:flex}
  .detail-card{width:min(1100px,96vw);max-height:92vh;background:linear-gradient(180deg,#081123, #07101a);border-radius:14px;padding:18px;display:grid;grid-template-columns:360px 1fr;gap:16px;overflow:auto;border:1px solid rgba(255,255,255,0.03)}
  .detail .poster{height:520px;border-radius:10px}
  .detail h2{margin:0 0 6px}
  .genres{font-size:13px;color:var(--muted);margin-bottom:8px}
  .overview{font-size:14px;line-height:1.5;color:#d6e7ff}
  .providers{margin-top:10px}
  .providers img{height:34px;margin-right:8px;vertical-align:middle}
  .video-wrap{margin-top:12px}
  .video-wrap iframe, .video-wrap video{width:100%;height:360px;border-radius:10px;border:0;background:#000}
  .source-input{display:flex;gap:8px;align-items:center;margin-top:10px}
  .small{font-size:13px;color:var(--muted)}
  footer{padding:12px;text-align:center;color:var(--muted);font-size:20px;position:relative}
  @media(max-width:900px){main{grid-template-columns:1fr} .detail-card{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div class="logo">
    <div class="dot">💖M-B💞</div>
    <div>
      <h1>JOY-HIPSTER TRAILER MOVIES HUB🎬</h1>
      <marquee><strong><b>ENJOY YOUR BEST MOVIE TRAILES, SEARCH FOR POPULAR MOVIES AND ENJOY MY FUNS...</b></strong></marquee>
    </div>
  </div>

  <div class="searchbar" role="search">
    <input id="q" type="search" placeholder="Search movies (eg. Inception)" />
    <button id="searchBtn">Search</button>
    <button id="popularBtn" title="Show popular movies">Popular</button>
  </div>
</header>

<main>
  <section>
    <div class="notice">
      <strong>Usage:</strong> This app searches TMDB for metadata and plays trailers. To stream  a movie. Do not use this interface to access copyrighted content illegally.
    </div>

    <div id="results" class="results" aria-live="polite"></div>

    <button id="loadMore" class="load-more">Load more</button>
  </section>

  <aside class="sidebar">
    <div class="small">API Key: <code id="apikeyLabel"></code></div>
    <div style="height:10px"></div>
    <div>
      <label class="small">Theme</label>
      <div class="controls">
        <button id="themeDefault">Default</button>
        <button id="themePink">Pink</button>
      </div>
    </div>

    <div style="height:12px"></div>
  </aside>
</main>

<!-- detail modal -->
<div id="detail" class="detail" role="dialog" aria-hidden="true">
  <div class="detail-card" role="document">
    <div>
      <div id="detPoster" class="poster"></div>
      <div style="margin-top:10px">
        <div class="small">Add custom source (direct mp4 url) — for personal or licensed files only</div>
        <div class="source-input">
          <input id="customUrl" placeholder="https://yourserver.com/file.mp4" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit" />
          <button id="addSourceBtn">Add</button>
        </div>
        <div style="height:8px"></div>
        <div id="currentSource" class="small">No custom source</div>
      </div>
    </div>

    <div>
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <div>
          <h2 id="detTitle"></h2>
          <div class="genres" id="detMeta"></div>
        </div>
        <div style="display:flex;gap:8px">
          <button id="closeDetail">Close</button>
        </div>
      </div>

      <div class="overview" id="detOverview"></div>

      <div class="providers" id="detProviders"></div>

      <div class="video-wrap" id="videoWrap">
        <!-- trailer iframe or <video> will be injected -->
      </div>

      <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
        <button id="playSource">Play custom source</button>
        <a id="downloadBtn" style="display:inline-block;text-decoration:none;" download><button id="downloadAction">Download source</button></a>
        <button id="openYT">Open Trailer on YouTube</button>
      </div>

    </div>
  </div>
</div>

<footer>
  <marquee><strong><b>@BRIAN Vs MERAB SYSTEM | 2025/26</b></strong></strong></marquee><br>¶Built with TMDB metadata • Trailers via YouTube • For legal/educational/demo use only.
</footer>

<script>
/* ========== CONFIG (you already provided) ========== */
const apikey = "e950e51d5d49e85f7c2f17f01eb23ba3";
const apiEndpoint = "https://api.themoviedb.org/3";
const imgPath = "https://image.tmdb.org/t/p/original";

/* UI refs */
const q = document.getElementById('q');
const searchBtn = document.getElementById('searchBtn');
const popularBtn = document.getElementById('popularBtn');
const results = document.getElementById('results');
const loadMore = document.getElementById('loadMore');
const apiLabel = document.getElementById('apikeyLabel');
apiLabel.textContent = apikey.slice(0,6) + '••••••••' + apikey.slice(-4);

/* detail refs */
const detail = document.getElementById('detail');
const detPoster = document.getElementById('detPoster');
const detTitle = document.getElementById('detTitle');
const detMeta = document.getElementById('detMeta');
const detOverview = document.getElementById('detOverview');
const detProviders = document.getElementById('detProviders');
const videoWrap = document.getElementById('videoWrap');
const closeDetail = document.getElementById('closeDetail');
const customUrlInput = document.getElementById('customUrl');
const addSourceBtn = document.getElementById('addSourceBtn');
const currentSource = document.getElementById('currentSource');
const playSource = document.getElementById('playSource');
const downloadBtn = document.getElementById('downloadBtn');
const downloadAction = document.getElementById('downloadAction');
const openYT = document.getElementById('openYT');

/* state */
let page = 1;
let lastQuery = '';
let lastResults = [];
let selectedMovie = null;
let customSourceUrl = ''; // per-session custom source (user-provided)

/* helpers */
function safeFetch(url){
  return fetch(url).then(r => {
    if(!r.ok) throw new Error('HTTP ' + r.status);
    return r.json();
  });
}

function makeCard(movie){
  const el = document.createElement('div');
  el.className = 'card';
  const poster = movie.poster_path ? imgPath + movie.poster_path : '';
  el.innerHTML = `
    <div class="poster" style="background-image:url('${poster.replace("'", "")}');"></div>
    <div class="meta">
      <h3>${escapeHtml(movie.title || movie.name || 'Untitled')}</h3>
      <p>${movie.release_date ? movie.release_date.slice(0,4) : ''} • ${truncate(movie.overview || '', 90)}</p>
    </div>
  `;
  el.addEventListener('click', ()=> openDetail(movie.id));
  return el;
}

function truncate(s,n){ return s && s.length>n ? s.slice(0,n-1)+'…' : (s||'')}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]) }

/* Search & populate */
async function search(query, reset=true){
  if(reset){ page = 1; results.innerHTML=''; lastResults=[] }
  lastQuery = query;
  const url = new URL(apiEndpoint + '/search/movie');
  url.search = new URLSearchParams({api_key:apikey,query,language:'en-US',page});
  try{
    const data = await safeFetch(url);
    data.results.forEach(m=>{
      lastResults.push(m);
      results.appendChild(makeCard(m));
    });
    if(data.page < data.total_pages) loadMore.style.display='block'; else loadMore.style.display='none';
  }catch(err){
    alert('Search error: ' + err.message);
  }
}

async function popular(reset=true){
  if(reset){ page=1; results.innerHTML=''; lastResults=[] }
  const url = new URL(apiEndpoint + '/movie/popular');
  url.search = new URLSearchParams({api_key:apikey,language:'en-US',page});
  try{
    const data = await safeFetch(url);
    data.results.forEach(m=>{
      lastResults.push(m);
      results.appendChild(makeCard(m));
    });
    if(data.page < data.total_pages) loadMore.style.display='block'; else loadMore.style.display='none';
  }catch(err){
    alert('Popular fetch error: ' + err.message);
  }
}

loadMore.addEventListener('click', ()=>{
  page++;
  if(lastQuery) search(lastQuery, false);
  else popular(false);
});

/* events */
searchBtn.addEventListener('click', ()=> {
  const val = q.value.trim();
  if(!val) { alert('Type something to search'); return }
  search(val);
});
q.addEventListener('keydown', (e)=> { if(e.key==='Enter'){ searchBtn.click() }});
popularBtn.addEventListener('click', ()=> popular());

/* detail modal open */
async function openDetail(movieId){
  selectedMovie = null;
  videoWrap.innerHTML = '<div class="small">Loading details…</div>';
  detail.setAttribute('aria-hidden','false'); detail.classList.add('open');
  try{
    const movie = await safeFetch(`${apiEndpoint}/movie/${movieId}?api_key=${apikey}&language=en-US`);
    selectedMovie = movie;
    detPoster.style.backgroundImage = movie.poster_path ? `url(${imgPath + movie.poster_path})` : '';
    detTitle.textContent = movie.title + (movie.release_date ? ` (${movie.release_date.slice(0,4)})` : '');
    detMeta.textContent = (movie.runtime ? movie.runtime+'m • ' : '') + (movie.genres ? movie.genres.map(g=>g.name).join(', ') : '');
    detOverview.textContent = movie.overview || 'No overview available.';
    // watch/providers
    detProviders.innerHTML = '<div class="small">Providers:</div>';
    try{
      const providers = await safeFetch(`${apiEndpoint}/movie/${movieId}/watch/providers?api_key=${apikey}`);
      const country = 'US'; // we show US by default; you may adapt
      const list = (providers.results && providers.results[country]) || providers.results['US'] || null;
      if(list && (list.flatrate || list.rent || list.buy)){
        const wrap = document.createElement('div');
        ['flatrate','rent','buy'].forEach(k=>{
          if(list[k]){
            const group = document.createElement('div');
            group.innerHTML = '<strong class="small">'+k+':</strong> ';
            list[k].forEach(p=>{
              const img = document.createElement('img');
              img.src = p.logo_path ? 'https://image.tmdb.org/t/p/original'+p.logo_path : '';
              img.alt = p.provider_name;
              img.title = p.provider_name;
              group.appendChild(img);
            });
            wrap.appendChild(group);
          }
        });
        detProviders.appendChild(wrap);
      } else detProviders.innerHTML += '<div class="small">No provider data for selected region.</div>';
    }catch(e){ detProviders.innerHTML += '<div class="small">Providers unavailable.</div>' }
    // trailer
    try{
      const videos = await safeFetch(`${apiEndpoint}/movie/${movieId}/videos?api_key=${apikey}&language=en-US`);
      const yt = videos.results.find(v=>v.site==='YouTube' && v.type.toLowerCase().includes('trailer'));
      if(yt){
        const iframe = document.createElement('iframe');
        iframe.src = `https://www.youtube.com/embed/${yt.key}?rel=0`;
        iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
        iframe.loading = 'lazy';
        videoWrap.innerHTML = '';
        videoWrap.appendChild(iframe);
        openYT.onclick = ()=> window.open(`https://www.youtube.com/watch?v=${yt.key}`,'_blank');
      } else {
        videoWrap.innerHTML = '<div class="small">No trailer found. You can add a custom source below.</div>';
        openYT.onclick = ()=> alert('Trailer not found.');
      }
    }catch(e){ videoWrap.innerHTML = '<div class="small">Videos unavailable.</div>'; openYT.onclick=()=>{} }
    // reset custom source text for this movie
    customSourceUrl = '';
    customUrlInput.value = '';
    currentSource.textContent = 'No custom source';
    downloadBtn.style.display = 'none';
  }catch(err){
    alert('Detail fetch error: ' + err.message);
    closeDetail.click();
  }
}

/* close detail */
closeDetail.addEventListener('click', ()=> {
  detail.classList.remove('open');
  detail.setAttribute('aria-hidden','true');
  videoWrap.innerHTML = '';
});

/* add custom source (user-provided direct mp4 url) */
addSourceBtn.addEventListener('click', ()=>{
  const val = customUrlInput.value.trim();
  if(!val){ alert('Paste a direct mp4 or webm URL'); return }
  // tiny validation
  if(!val.match(/^https?:\/\/.+\.(mp4|webm|ogg)(\?.*)?$/i)){
    if(!confirm('URL does not look like an mp4/webm. Keep anyway?')) return;
  }
  customSourceUrl = val;
  currentSource.textContent = 'Custom source: ' + customSourceUrl;
  downloadBtn.style.display = 'inline-block';
  downloadBtn.href = customSourceUrl;
  downloadBtn.setAttribute('download','movie-file');
  // auto play the source
  playCustomSource();
});

/* play custom source in the videoWrap */
function playCustomSource(){
  if(!customSourceUrl){ alert('No custom source set'); return }
  videoWrap.innerHTML = '';
  const vid = document.createElement('video');
  vid.controls = true;
  vid.playsInline = true;
  vid.src = customSourceUrl;
  vid.autoplay = true;
  vid.style.maxHeight = '60vh';
  videoWrap.appendChild(vid);
}

/* play button */
playSource.addEventListener('click', ()=> {
  playCustomSource();
});

/* download action: anchor already set; note browsers/CORS may restrict cross-origin downloads */
downloadAction.addEventListener('click', (e)=>{
  if(!customSourceUrl){ e.preventDefault(); alert('No custom source to download. Add a legal file URL first.'); return; }
  // Allow default anchor behavior; if CORS blocks, user may need server with CORS or to host file with correct headers.
});

/* small extras: theme toggles */
document.getElementById('themeDefault').addEventListener('click', ()=> {
  document.documentElement.style.setProperty('--accent','#8b5cf6');
});
document.getElementById('themePink').addEventListener('click', ()=> {
  document.documentElement.style.setProperty('--accent','#fb7185');
});

/* initial load: popular */
popular();

/* Utility: click outside detail to close */
detail.addEventListener('click', (ev)=>{
  if(ev.target === detail) closeDetail.click();
});

</script>
</body>
      </html>  <main>
    <div class="container">
      <!-- Left: Scanner -->
      <div class="card">
        <div style="display:flex;flex-direction:column;gap:8px;align-items:center">
          <div id="reader" aria-hidden="true">
            <div class="center" id="reader-note">Camera initializing… allow camera permission when prompted</div>
          </div>

          <div class="controls">
            <button id="scan-toggle" class="btn">⏸ Pause Scan</button>
            <button id="upload-btn" class="btn ghost">📁 Upload Image</button>
            <button id="flash-btn" class="btn ghost">🔦 Toggle Flash</button>
            <button id="stop-btn" class="btn ghost">⛔ Stop Camera</button>
            <button id="copy-last" class="btn ghost">📋 Copy Last</button>
          </div>

          <div class="status-line center" id="scan-status">No code scanned yet. Align a code inside the frame or upload an image.</div>
        </div>
      </div>

      <!-- Right: Product / Info -->
      <aside class="side">
        <div class="product-card card">
          <div style="display:flex;gap:12px;align-items:flex-start">
            <div style="flex:1">
              <div class="product-name" id="product-name">Product Name</div>
              <div class="product-desc" id="product-desc">Scan a code to get product details (online lookup first, then local fallback).</div>
              <div class="status-line" id="product-meta">—</div>
            </div>
            <div style="width:120px">
              <img id="product-image" src="" alt="product" class="product-image" style="display:none" />
            </div>
          </div>
        </div>

        <div class="card">
          <div class="small muted">Quick actions</div>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button id="open-settings-2" class="btn ghost">⚙️ Settings</button>
            <button id="view-history-btn" class="btn">📜 View History</button>
            <button id="clear-storage" class="btn ghost">🧹 Clear History</button>
          </div>
        </div>

        <div class="card small muted center">
          Tip: If the internet is unavailable the scanner will look up products from the local fallback DB.
        </div>
      </aside>
    </div>
  </main>

  <footer>
    <div>© <strong>MERA-B</strong> • Neon Smart Scanner</div>
    <div class="small muted">Built with HTML5 QRCode • Product info via UPCitemDB (trial) • Local fallback</div>
  </footer>

  <!-- Settings Drawer -->
  <aside class="settings-drawer" id="settings-drawer" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="drawer-title">Settings</div>
        <div class="small muted">Preferences & history</div>
      </div>
      <div><button id="close-settings" class="btn ghost">✖</button></div>
    </div>

    <div style="display:flex;flex-direction:column;gap:12px">
      <div class="toggle">
        <div>
          <div style="font-weight:700">Theme</div>
          <div class="small muted">Switch dark / light</div>
        </div>
        <div id="theme-switch" class="switch" role="switch" aria-checked="false" tabindex="0"><div class="knob"></div></div>
      </div>

      <div class="toggle" style="justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700">Scan history</div>
          <div class="small muted">Persisted locally in browser</div>
        </div>
        <div style="display:flex;gap:8px">
          <button id="open-history-in-drawer" class="btn">📜 View</button>
        </div>
      </div>

      <div style="display:flex;gap:8px">
        <button id="export-csv" class="btn ghost">⬇️ Export CSV</button>
        <button id="clear-history-drawer" class="btn ghost">🗑️ Clear History</button>
      </div>

      <div class="small muted">Drawer slides from the right and fades on exit for a smooth feel.</div>
    </div>
  </aside>

  <!-- History Overlay -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="history-modal" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:800">Scan History</div>
          <div class="small muted">All scans saved locally (persist across sessions)</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="export-csv-2" class="btn">⬇️ Export CSV</button>
          <button id="close-history" class="btn ghost">Close</button>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="search-history" placeholder="Search code or type…" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--neon-a)" />
        <button id="clear-history" class="btn ghost">Clear</button>
      </div>

      <div class="history-list" id="history-list" aria-live="polite" style="margin-top:8px"></div>

      <div class="small muted center" style="margin-top:8px">Export or clear history from here.</div>
    </div>
  </div>

  <script>
    // -------------------------
    // Local fallback product DB (edit or extend)
    // -------------------------
    const localProductDB = {
      "123456": { name: "Wireless Headphones", description: "High-quality sound with noise cancellation.", image: "" },
      "789012": { name: "Smart Watch", description: "Tracks fitness, heart rate, and notifications.", image: "" },
      "012345678905": { name: "Sample Bottle Water (UPC)", description: "500ml mineral water.", image: "" },
      "qrcode-abc": { name: "Promo Code", description: "Get 20% off your next purchase!", image: "" }
    };

    // -------------------------
    // Storage keys & helpers
    // -------------------------
    const LSK = { HISTORY: 'neon_scanner_history_v2', THEME: 'neon_scanner_theme_v2' };
    const $ = id => document.getElementById(id);
    function nowString(ts = Date.now()){ return new Date(ts).toLocaleString(); }
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function detectType(decodedText, decodedResult){
      try { const fmt = decodedResult?.result?.format?.formatName || decodedResult?.format?.formatName || null; if(fmt) return fmt; } catch(e){}
      if(/^https?:\/\//i.test(decodedText)) return 'QR (URL)';
      if(/^[0-9\-]{6,}$/.test(decodedText)) return 'Barcode';
      return 'QR/Code';
    }

    function saveHistoryEntry(entry){
      const raw = localStorage.getItem(LSK.HISTORY); let arr = raw ? JSON.parse(raw) : [];
      arr.unshift(entry); if(arr.length > 1000) arr = arr.slice(0,1000);
      localStorage.setItem(LSK.HISTORY, JSON.stringify(arr));
    }
    function loadHistory(){ const raw = localStorage.getItem(LSK.HISTORY); return raw ? JSON.parse(raw) : []; }
    function clearHistoryStorage(){ localStorage.removeItem(LSK.HISTORY); }

    // -------------------------
    // UPCitemDB product lookup (online) with offline fallback
    // -------------------------
    async function lookupProductFromApi(code){
      // UPCitemDB trial endpoint (rate-limited). Replace with your paid endpoint if available.
      // Example: https://api.upcitemdb.com/prod/trial/lookup?upc=012345678905
      try {
        const url = `https://api.upcitemdb.com/prod/trial/lookup?upc=${encodeURIComponent(code)}`;
        const res = await fetch(url, { method: 'GET' }); // add headers for paid API if needed
        if(!res.ok) throw new Error('API error');
        const data = await res.json();
        if(data && data.code === "OK" && data.total > 0 && data.items && data.items.length){
          // map to unified object
          const it = data.items[0];
          return {
            name: it.title || it.description || code,
            description: it.description || (it.offers && it.offers.length ? it.offers[0].merchant : ''),
            image: (it.images && it.images.length) ? it.images[0] : ''
          };
        }
        throw new Error('Not found');
      } catch (e) {
        // propagate to caller so it can fallback
        throw e;
      }
    }

    async function findProduct(code){
      // First try online API
      try {
        const product = await lookupProductFromApi(code);
        return { source: 'api', product };
      } catch(apiErr){
        // fallback to local DB
        const local = localProductDB[code];
        if(local) return { source: 'local', product: local };
        return { source: 'none', product: null };
      }
    }

    // -------------------------
    // Html5Qrcode setup & handlers
    // -------------------------
    let html5QrCode = null;
    let scanning = true;
    let lastScannedCode = "";
    let lastScanMeta = null;
    let isFlashOn = false;

    async function startCameraScan(){
      try {
        if(!html5QrCode) html5QrCode = new Html5Qrcode("reader", { experimentalFeatures: { useBarCodeDetectorIfSupported: true } });
        const cameras = await Html5Qrcode.getCameras();
        let selected = cameras && cameras.length ? cameras[0] : null;
        for(const cam of (cameras||[])) if(/back|rear|environment/i.test(cam.label)){ selected = cam; break; }
        const currentCameraId = selected?.id || null;
        await html5QrCode.start(
          currentCameraId ? { deviceId: { exact: currentCameraId } } : { facingMode: "environment" },
          { fps: 10, qrbox: computeQrBox() },
          onScanSuccess,
          onScanError
        );
        scanning = true;
        $('scan-toggle').innerText = '⏸ Pause Scan';
        $('scan-status').innerText = '🔍 Scanning…';
        $('ready-dot').innerText = 'ready';
      } catch(err){
        console.error("Camera start failed:", err);
        $('scan-status').innerText = '⚠️ Camera access failed. Try image upload or allow permissions.';
        $('ready-dot').innerText = 'camera failed';
      }
    }

    function computeQrBox(){
      const w = Math.min(window.innerWidth * 0.8, 640);
      const size = Math.floor(Math.min(420, Math.max(220, w * 0.6)));
      return { width: size, height: size };
    }

    function stopCamera(){
      if(html5QrCode){
        html5QrCode.stop().catch(()=>{}).finally(()=>{
          scanning = false;
          $('scan-toggle').innerText = '▶️ Resume Scan';
          $('scan-status').innerText = '⏸ Camera stopped.';
          $('ready-dot').innerText = 'stopped';
        });
      }
    }

    async function toggleFlash(){
      try {
        if(!html5QrCode) return;
        if(typeof html5QrCode.applyVideoConstraints === 'function'){
          isFlashOn = !isFlashOn;
          const constraints = { advanced: [{ torch: !!isFlashOn }] };
          await html5QrCode.applyVideoConstraints(constraints);
        } else {
          const stream = html5QrCode.getState()?.stream;
          const track = stream?.getVideoTracks?.()[0];
          if(track && typeof track.getCapabilities === 'function'){
            const caps = track.getCapabilities();
            if(caps.torch){
              isFlashOn = !isFlashOn;
              await track.applyConstraints({ advanced: [{ torch: isFlashOn }] });
            } else {
              alert('Flash/torch not supported on this device.');
            }
          } else {
            alert('Flash/torch control not available.');
          }
        }
        $('flash-btn').innerText = isFlashOn ? '🔦 Flash ON' : '🔦 Toggle Flash';
      } catch(e){
        console.warn("Flash toggle error:", e);
        alert('Unable to toggle flash on this device.');
      }
    }

    async function onScanSuccess(decodedText, decodedResult){
      if(decodedText === lastScannedCode) return; // de-bounce duplicate reads
      lastScannedCode = decodedText;
      const type = detectType(decodedText, decodedResult);
      lastScanMeta = { code: decodedText, type, ts: Date.now() };

      $('scan-status').innerText = `✅ Scanned: ${decodedText}`;
      $('product-meta').innerText = `${type} • ${nowString(lastScanMeta.ts)}`;
      // lookup product (api -> fallback)
      try {
        const lookup = await findProduct(decodedText);
        if(lookup.source === 'api' || lookup.source === 'local'){
          const p = lookup.product;
          $('product-name').innerText = p.name || decodedText;
          $('product-desc').innerText = p.description || 'No description available.';
          if(p.image){
            $('product-image').src = p.image; $('product-image').style.display = 'block';
          } else { $('product-image').style.display = 'none'; }
          lastScanMeta.productName = p.name || null;
          lastScanMeta.source = lookup.source;
        } else {
          $('product-name').innerText = decodedText.length > 40 ? decodedText.slice(0,40) + '…' : decodedText;
          $('product-desc').innerText = 'No product details found online or in local DB.';
          $('product-image').style.display = 'none';
          lastScanMeta.source = 'none';
        }
      } catch(e){
        console.error('Lookup error',e);
        $('product-desc').innerText = 'Lookup error. See console for details.';
      }

      saveHistoryEntry(lastScanMeta);
    }

    function onScanError(err){
      // ignore noisy errors
    }

    // -------------------------
    // Image Upload scanning
    // -------------------------
    $('upload-btn').addEventListener('click', ()=>{
      const inp = document.createElement('input'); inp.type = 'file'; inp.accept = 'image/*';
      inp.onchange = async (ev) => {
        const f = ev.target.files[0]; if(!f) return;
        try {
          $('scan-status').innerText = '⏳ Scanning image…';
          if(!html5QrCode) html5QrCode = new Html5Qrcode("reader");
          const decoded = await html5QrCode.scanFile(f, true);
          // some builds return single decoded text, others array
          const decodedText = Array.isArray(decoded) ? decoded[0] : decoded;
          onScanSuccess(decodedText, null);
        } catch(e){
          console.error("Image scan failed:", e);
          $('scan-status').innerText = '❌ Image scan failed. No code found.';
        }
      };
      inp.click();
    });

    // -------------------------
    // UI Button behaviors
    // -------------------------
    $('scan-toggle').addEventListener('click', async ()=>{
      if(!html5QrCode) return;
      if(scanning){
        try { await html5QrCode.pause(true); scanning = false; $('scan-toggle').innerText = '▶️ Resume Scan'; $('scan-status').innerText = '⏸ Scanning paused.'; } catch(e){ await html5QrCode.stop(); scanning=false; $('scan-toggle').innerText='▶️ Resume Scan'; }
      } else {
        try { await html5QrCode.resume(); scanning = true; $('scan-toggle').innerText = '⏸ Pause Scan'; $('scan-status').innerText = '🔍 Scanning…'; } catch(e){ startCameraScan(); }
      }
    });

    $('stop-btn').addEventListener('click', ()=> stopCamera());
    $('flash-btn').addEventListener('click', ()=> toggleFlash());
    $('copy-last').addEventListener('click', ()=> {
      if(!lastScannedCode) return alert('No code scanned yet.');
      navigator.clipboard?.writeText(lastScannedCode).then(()=> { alert('Copied to clipboard'); }).catch(()=> alert('Copy failed'));
    });

    // -------------------------
    // Drawer & history UI
    // -------------------------
    const drawer = $('settings-drawer');
    function openDrawer(){ drawer.classList.remove('closing'); drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); }
    function closeDrawer(){ drawer.classList.remove('open'); drawer.classList.add('closing'); drawer.setAttribute('aria-hidden','true'); setTimeout(()=>drawer.classList.remove('closing'),380); }
    $('open-settings').addEventListener('click', openDrawer); $('open-settings-2').addEventListener('click', openDrawer); $('close-settings').addEventListener('click', closeDrawer);

    // Theme
    const themeSwitch = $('theme-switch');
    function applyTheme(theme){
      if(theme === 'light'){ document.documentElement.classList.add('light'); themeSwitch.classList.add('on'); themeSwitch.setAttribute('aria-checked','true'); } else { document.documentElement.classList.remove('light'); themeSwitch.classList.remove('on'); themeSwitch.setAttribute('aria-checked','false'); }
      localStorage.setItem(LSK.THEME, theme);
    }
    themeSwitch.addEventListener('click', ()=> applyTheme(document.documentElement.classList.contains('light') ? 'dark' : 'light'));
    themeSwitch.addEventListener('keydown', (e)=> { if(e.key === 'Enter' || e.key === ' ') themeSwitch.click(); });
    (function(){ const saved = localStorage.getItem(LSK.THEME) || 'dark'; applyTheme(saved); })();

    // History overlay
    const overlay = $('overlay'), historyList = $('history-list'), searchInput = $('search-history');
    function renderHistory(filter=''){
      const arr = loadHistory(); historyList.innerHTML = '';
      const q = (filter||'').toLowerCase();
      const filtered = arr.filter(it => { if(!q) return true; return (it.code||'').toLowerCase().includes(q) || (it.type||'').toLowerCase().includes(q) || nowString(it.ts).toLowerCase().includes(q); });
      if(filtered.length === 0){ historyList.innerHTML = '<div class="small muted center">No history found.</div>'; return; }
      for(const it of filtered){
        const div = document.createElement('div'); div.className = 'history-item';
        div.innerHTML = `<div style="display:flex;flex-direction:column;gap:6px;flex:1"><div class="code">${escapeHtml(it.code)}</div><div class="meta">${escapeHtml(it.type)} • ${nowString(it.ts)}${it.productName? ' • ' + escapeHtml(it.productName):''} ${it.source? ' • ' + escapeHtml(it.source):''}</div></div><div style="display:flex;gap:8px;align-items:center"><button class="btn ghost copy-btn">Copy</button></div>`;
        const copyBtn = div.querySelector('.copy-btn'); copyBtn.addEventListener('click', ()=> { navigator.clipboard?.writeText(it.code).then(()=> { copyBtn.innerText='Copied'; setTimeout(()=> copyBtn.innerText='Copy',900); }).catch(()=> alert('Copy failed')); });
        historyList.appendChild(div);
      }
    }
    function openHistory(){ renderHistory(); overlay.classList.add('open'); overlay.setAttribute('aria-hidden','false'); }
    function closeHistory(){ overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true'); }
    $('view-history-btn').addEventListener('click', openHistory); $('open-history-in-drawer').addEventListener('click', ()=> { openHistory(); closeDrawer(); });
    $('close-history').addEventListener('click', closeHistory);
    $('export-csv').addEventListener('click', ()=> exportHistoryCsv()); $('export-csv-2').addEventListener('click', ()=> exportHistoryCsv());
    $('clear-history').addEventListener('click', ()=> { if(confirm('Clear all history?')){ clearHistoryStorage(); renderHistory(); }});
    $('clear-history-drawer').addEventListener('click', ()=> { if(confirm('Clear all history?')) clearHistoryStorage(); });
    $('clear-storage').addEventListener('click', ()=> { if(confirm('Clear all saved scan history?')){ clearHistoryStorage(); alert('History cleared.'); }});

    searchInput.addEventListener('input', (e)=> renderHistory(e.target.value) );
    overlay.addEventListener('click', (e)=> { if(e.target === overlay) closeHistory(); });

    // -------------------------
    // CSV export
    // -------------------------
    function exportHistoryCsv(){
      const arr = loadHistory();
      if(!arr.length){ alert('No history to export'); return; }
      const headers = ['code','type','timestamp','readable_time','productName','source'];
      const rows = arr.map(it => [`"${(it.code||'').replace(/"/g,'""')}"`,`"${(it.type||'').replace(/"/g,'""')}"`,it.ts,`"${nowString(it.ts)}"`,`"${(it.productName||'').replace(/"/g,'""')}"`,`"${(it.source||'').replace(/"/g,'""')}"`].join(','));
      const csv = [headers.join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `scan-history-${Date.now()}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // -------------------------
    // init on load & resize behavior
    // -------------------------
    window.addEventListener('load', async ()=>{
      startCameraScan();
      const arr = loadHistory();
      if(arr && arr.length){
        const last = arr[0];
        $('product-name').innerText = localProductDB[last.code]?.name || (last.productName || last.code);
        $('product-desc').innerText = localProductDB[last.code]?.description || (last.productName ? 'Last scanned item' : 'Last scanned code');
        $('product-meta').innerText = `${last.type} • ${nowString(last.ts)}`;
      }
      renderHistory();
      // recompute qrbox on resize (restart camera)
      let szTO = null;
      window.addEventListener('resize', ()=> {
        clearTimeout(szTO);
        szTO = setTimeout(()=> {
          if(html5QrCode && typeof html5QrCode.getState === 'function' && html5QrCode.getState()?.running){
            html5QrCode.stop().then(()=> startCameraScan()).catch(()=> startCameraScan());
          }
        }, 220);
      });
    });

    // keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if(e.key === 'h' && (e.ctrlKey || e.metaKey)){ e.preventDefault(); openHistory(); }
      if(e.key === 's' && (e.ctrlKey || e.metaKey)){ e.preventDefault(); exportHistoryCsv(); }
      if(e.key === 'Escape'){ closeHistory(); closeDrawer(); }
    });

    // -------------------------
    // Helper: findProduct wrapper with fallback handling and UI messages
    // -------------------------
    async function findProduct(code){
      // show searching UI
      $('product-desc').innerText = 'Looking up product… (online first)';
      try {
        const result = await lookupProductFromApi(code);
        // success: return unified
        return { source: 'api', product: result };
      } catch(e){
        // online failed or not found -> try local
        const local = localProductDB[code];
        if(local) return { source: 'local', product: local };
        // else none
        return { source: 'none', product: null };
      }
    }

    // -------------------------
    // Small polyfill: Html5Qrcode scanFile sometimes returns array or string
    // -------------------------
    // (Already handled in image upload logic)

  </script>
</body>
  </html>
